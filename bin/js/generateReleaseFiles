#!/usr/bin/env node

/**
 * Generate release files for usage in the release asset and dist repo
 * - scopes dependency namespaces using php-scoper
 * - creates a folder scoped/ with all required plugin files
 * - creates a zip file from the scoped/ folder, named after the package
 */

import { existsSync, mkdirSync, rmSync, unlinkSync } from "fs";
import { basename, resolve } from "path";
import { cwd, exit, env } from "process";
import { error, getPackageInfos, info, run, line, success } from "./support.js";

/** Validate that we are at the project root */
const projectRoot = cwd();
if (!existsSync(resolve(projectRoot, ".gitignore"))) {
  error(`${basename(__filename)} must run from the package root`);
  exit(1);
}

const phpScoperDownloadUrl =
  "https://github.com/humbug/php-scoper/releases/latest/download/php-scoper.phar";

const { name: packageName } = getPackageInfos();

line();
info(`Creating a scoped release for ${packageName}...`);
line();

// Install Composer dependencies in GitHub Actions
if (env.GITHUB_ACTIONS === "true") {
  console.log("ðŸ’¡ Installing composer dependencies...");
  run("composer install --no-scripts");
}

/** Ensure php-scoper is available */
const phpScoperPath = resolve(projectRoot, "bin/php-scoper");
if (!existsSync(phpScoperPath)) {
  info("Ensuring php-scoper is available...");
  mkdirSync(resolve(projectRoot, "bin"), { recursive: true });
  run(`curl -sL ${phpScoperDownloadUrl} -o ${phpScoperPath}`);
  run(`chmod +x ${phpScoperPath}`);
}

/** Scope namespaces using php-scoper */
info("Scoping namespaces using php-scoper...");
run(`rm -rf scoped && ${phpScoperPath} add-prefix --quiet --output-dir=scoped --config=bin/scoper.config.php`); // prettier-ignore
success("Successfully scoped all namespaces!");
line();

/** Dump the autoloader in the scoped directory */
info("Dumping the autoloader in the scoped directory...");
run("composer dump-autoload --working-dir=scoped --classmap-authoritative");

/** Clean up the scoped directory */
info("Cleaning up the scoped directory...");
["scoped/composer.json", "scoped/composer.lock"].forEach((file) => {
  rmSync(resolve(projectRoot, file), { force: true });
});

/** Create a zip file from the scoped directory */
info("Creating a zip file from the scoped directory...");
run(`cd scoped && zip -rq "../${packageName}.zip" . && cd ..`);

line();
info(`âœ… Created a scoped release folder: scoped/`);
info(`âœ… Created a scoped release asset: ${packageName}.zip`);
line();
