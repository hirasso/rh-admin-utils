#!/usr/bin/env node

/**
 * Prepares the dist folder
 * - clones the dist repo into dist/
 * - checks out the empty root commit in dist/
 * - copies all files from scoped/ into dist/
 */

import { cpSync, existsSync, rmSync } from "fs";
import { basename, resolve } from "path";
import { cwd, exit, env } from "process";
import { run, info, success, error, getInfosFromComposerJSON, dd } from "./support.js";

const { owner, repo } = getInfosFromComposerJSON();
if (!owner || !repo) {
  error(`Could not read owner and repo`, { owner, repo });
}

// Ensure the script is run from the project root
if (!existsSync(resolve(cwd(), ".gitignore"))) {
  error(`${basename(__filename)} must run from the package root`);
}

// Check if the `scoped` folder exists
if (!existsSync("scoped")) {
  error("The 'scoped' folder does not exist");
}

// Initialize the dist folder if not in GitHub Actions
if (env.GITHUB_ACTIONS !== "true") {
  info(`Cloning the dist repo into dist/`);
  rmSync("dist", { force: true });
  run(`git clone -b empty git@github.com:${owner}/${repo}-dist.git dist/`);
}

info(`Checking out the empty tagged root commit`);
run("git -C dist checkout --detach empty");

info(`Copying files from scoped/ to dist/`);
cpSync("scoped", "dist", { recursive: true, force: true });

info(`Overwriting the composer.json in dist/`);
cpSync("composer.dist.json", "dist/composer.json");

success(`Dist folder preparation complete!`);
